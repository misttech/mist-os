# How the platform build manages IDKs and SDKs

This document describes how the Fuchsia IDKs and Bazel SDKs
are generated by the platform build, the role of each instance
and their relationships. This information is crucial for the
rest of the migration to Bazel, and will be updated accordingly.

## The GN-generated IDKs and Bazel SDKs

### The Fuchsia Core IDK

The GN `//sdk:final_fuchsia_idk` target is used to build and
validate the Fuchsia Core IDK, which is the official archive
distributed to third-party developers, and which all atoms in
the "partner" category, as well as prebuilt binaries for all
supported CPU architectures, and supported API levels.

Currently, this is built directly from Ninja (no Bazel required)
as the shape of the Core IDK (i.e. which atoms it includes) it
entirely defined in the GN build graph.

Note that building the core IDK is very long, due to the high number
of `(cpu, api_level)` combinations it needs to support. Thus is only
built by a few dedicated builder configurations (e.g. `sdk-core-linux`).

### The Fuchsia Core Bazel SDK

The GN `//sdk:final_fuchsia_sdk` target is used to build and
validate the official Fuchsia Bazel SDK distributed to third-party
developers. It augments the Core IDK with our set of Bazel-specific
build rules and target declarations.

Its content is directly usable by third-party Bazel projects, which
can include it with a simple `local_repository()` directive in their
`WORKSPACE.bazel` file, such as:

```
local_repository(
    name = "fuchsia_sdk",
    path = "/path/to/final_fuchsia_sdk",
)
```

Just like the Fuchsia Core IDK, the Fuchsia Core Bazel SDK is
built directly from GN, without using any Bazel workspace, and
building it is so long that this is only done on a few dedicated
builder configurations (e.g. `sdk-bazel-linux`).

### The In-Tree IDK

The GN `//sdk:bazel_in_tree_idk` target is used to build an IDK
that has the same set of atoms as the core IDK, but which only
provides prebuilt binaries for the current `target_cpu` architecture,
and the `HEAD` API level. It is only intended to be used to
populate the `@fuchsia_sdk` and `@fuchsia_in_tree_idk`
repositories (described below).

### The In-Tree Internal IDK

The GN `//sdk:bazel_internal_only_idk` target groups atoms with
and unstable API and that are not ready to be moved to the "partner"
category. This should only be used to populate the `@internal_sdk`
repository of the in-tree Bazel workspace. These atoms should
never be used outside of the platform build.

It only contains prebuilt binaries for the current `target_cpu`
architecture, and the HEAD API level.

Nothing in the GN graph should depend on this.

## The Bazel external repositories

The platform build's internal Bazel workspace also uses a number
of external repositories that are related to the IDK and the Bazel SDK:

### The `@fuchsia_sdk` repository:

This repository exposes the same set of atoms and binaries as
the in-tree IDK, augmented with Bazel SDK rule definitions and
Bazel targets for each atom.

It is used by the `BUILD.bazel` files inside of `fuchsia.git`, to
use SDK atom targets and our set of Bazel rules to develop Fuchsia
packages with them.

Currently it is populated by parsing the content of the
Ninja-generated in-tree IDK with the `fuchsia_sdk_repository()`
rule, but this will change in the future, as described below.

### The `@internal_sdk` repository:

This repository exposes SDK atoms and binaries from the in-tree
internal IDK to the platform build's Bazel workspace. This means
that only prebuilts for the current `target_cpu` architecture and
 `HEAD` API  levels are available there.

Currently, this is populated by parsing the content of the
Ninjar-generated `//sdk:bazel_internal_only_Idk` IDK the
`fuchsia_sdk_repository()` rule.

This repository will disappear in the future. In the meantime,
how it is populated will change according to the steps described
later in this document.

### The `@fuchsia_in_tree_idk` repository:

This repository currently wraps the Ninja-generated in-tree IDK
as a Bazel repository. A key difference though is that its
metadata files contain Bazel target labels, instead of file
paths, for any buildable artifacts (i.e. not source files),
for example, `pkg/fdio/meta.json` looks like:

```
{
  "binaries": {
    "x64": {
      "debug": "@fuchsia_in_tree_idk//.build-id:15/646fc64e58e6bc964d5781afec10233689ab08.debug",
      "dist": "@fuchsia_in_tree_idk//arch/x64:dist/libfdio.so",
      "dist_path": "lib/libfdio.so",                             # <-- configuration string
      "link": "@fuchsia_in_tree_idk//arch/x64:lib/libfdio.so"   # <-- ninja artifact
    }
  },
  "deps": [],
  "format": "shared",
  "headers": [
    "pkg/fdio/include/lib/fdio/directory.h",   # <-- symlink to source file
    "pkg/fdio/include/lib/fdio/fd.h",          # <-- symlink to source file
    ...
  ],
  "ifs": "fdio.ifs",
  "include_dir": "pkg/fdio/include",
  "name": "fdio",
  "root": "pkg/fdio",
  "type": "cc_prebuilt_library"
}
```

In the current implementation, the labels point to simple
symlinks that go into the Ninja build directory. But this
extra level of indirection will allow, in the future, building
said artifacts directly with Bazel.

Note that this does *not* comply with the official IDK layout,
so its content cannot be used or distributed outside of the platform
build's Bazel workspace.

At the moment, this repository is defined but not used by the Bazel
workspace.

### The `@fuchsia_internal_only_sdk` repository:

This is similar to `@fuchsia_in_tree_idk`, but wraps the content of
the `//sdk:bazel_internal_only_idk` instead.

At the moment, this repository is defined by not used by the
Bazel workspace.

## The `generate_fuchsia_sdk_repository` GN target:

Calling `fx build generate_fuchsia_sdk_repository` will create a symlink
in `$(fx get-build-dir)/gen/build/bazel/fuchsia_sdk` which _currently_ points
to the content of the `@fuchsia_sdk` repository in the in-tree Bazel
workspace.

The role of this symlink is to serve as a directly-usable Bazel external
repository for any _external_ Bazel workspace that wants to use its
content. This is useful for at least two use cases:

- Running the Bazel SDK test suite, which has its own workspace under
  `//build/bazel_sdk/tests`, which is critical to verify that all the
  rules and target declarations provided work as expected.

- Possibly developing drivers or other Fuchsia software in `fuchsia.git`
  using the developer workflows provided by the Bazel SDK rules, which
  differ considerably from what `fx` can support, while still being
  able to access internal atoms at the HEAD API level, something that
  is not possible using the Core Bazel SDK.

  In both cases, this means setting up a separate Bazel workspace, and
  using a directive such as:

  ```
  local_repository(
      name = "fuchsia_sdk",
      path = "/path/to/generated/fuchsia_sdk",
  )
  ```

  Or using a `--repository_override=fuchsia_sdk=/path/to/generated/fuchsia_sdk`
  option when invoking Bazel.

And this is possible because the symlink points to a directory whose
content is directly usable by such workspaces.


# Existing dependencies

The following diagram illustrates the dependencies between the
items described above:

```
GN Build Graph                                      |  Bazel Workspace
                                                     |
                                                     |
  Core IDK                                           |
     |   //sdk:final_fuchsia_idk                     |
     |                                               |
  [fuchsia_sdk_repository() in Python]               |
     |                                               |
     v                                               |
  Core Bazel SDK                                     |
        //sdk:final_fuchsia_sdk                      |
                                                     |
                                                     |
  Bazel In-Tree IDK                                  |
    //sdk:bazel_in_tree_idk                          |
                 |  |                                |
                 |  `----------[fuchsia_idk_repository()]--> @fuchsia_in_tree_idk
                 |                                   |
                 `-------------[fuchsia_sdk_repository()]--> @fuchsia_sdk
                                                     |
  Bazel In-Tree Internal IDKon                       |
    //sdk:bazel_internal_only_idk                    |
                 |  |                                |
                 |  `----------[fuchsia_idk_repository()]--> @fuchsia_internal_only_idk
                 |                                   |
                 `-------------[fuchsia_sdk_repository()]--> @internal_sdk
                                                     |
```

## The `fuchsia_idk_repository()` function

This function takes an IDK as input, and populates a Bazel repository,
with it, changing the content of its metadata files to include Bazel
targets for buildable artifacts, plus adding the necessary `BUILD.bazel`
files that they reference.

Note that the output repository's content does not follow the
official IDK layout anymore, and should never be used outside of
the platform build's Bazel workspace.

## The `fuchsia_sdk_repository()` function

This function takes an IDK as input, and generates a Bazel SDK
directory or repository as output.

Its logic is written in a special way to allow it to run either in
a Starlark environment (i.e. as a Bazel repository rule), or in a
Python one (i.e. as a build action, either from Ninja or Bazel).

Currently, it is used as build time to generate the Core Bazel SDK
from the Core IDK, as a Ninja action.

It is also used as Starlark in the Bazel repository rules that generate
the `@fuchsia_sdk` and `@internal_sdk` repositories.

# Upcoming changes

Currently, the Platform IDK and Platform internal collection must
be fully built with Ninja before the Bazel workspace can be used,
which means developers need to wait several minutes before doing
any useful in Bazel, and generally blocks the rest of the platform
build's migration to Bazel.

The following describes the coming steps that will be performed
to remove this dependency while preserving development workflows.

## Populate `@fuchsia_sdk` from `@fuchsia_in_tree_idk`:

And respectively, populate `@internal_sdk` from the content of
`@fuchsia_internal_only_idk`.

This requires changing the `fuchsia_sdk_repository()` logic so
that it can recognize target labels inside IDK metadata files and
adjust accordingly. This implies this new relationship diagram:


```
GN Build Graph                                       |  Bazel Workspace
                                                     |
                                                     |
  Core IDK                                           |
     |   //sdk:final_fuchsia_idk                     |
     |                                               |
  [fuchsia_sdk_repository() in Python]               |
     |                                               |
     v                                               |
  Core Bazel SDK                                     |
        //sdk:final_fuchsia_sdk                      |
                                                     |
                                                     |
  Bazel In-Tree IDK                                  |
    //sdk:bazel_in_tree_idk                          |
                    |                                |
                    `----------[fuchsia_idk_repository()]-----> @fuchsia_in_tree_idk
                                                     |                   |
                                                     |                   |
                                                     |       [fuchsia_sdk_repository()]
                                                     |                   |
                                                     |                   v
                                                     |             @fuchsia_sdk
                                                     |
  Bazel In-Tree Internal IDK                         |
    //sdk:bazel_internal_only_idk                    |
                    |                                |
                    `----------[fuchsia_idk_repository()]--> @fuchsia_internal_only_idk
                                                     |                   |
                                                     |                   |
                                                     |       [fuchsia_sdk_repository()]
                                                     |                   |
                                                     |                   v
                                                     |             @internal_sdk
                                                     |
```

Note that this change will not impact anything outside of the `@fuchsia_sdk` and `@internal_sdk`
repositories, whose content will still be usable exactly in the same way by the rest
of the `BUILD.bazel` files of `fuchsia.git`. Even the `.bzl` files within these
repositories will stay unchanged.

## Generate final version `@fuchsia_sdk`.

A drawback of the previous step is that the content of `@fuchsia_sdk` contains
`BUILD.bazel` files that now contain references to `@fuchsia_in_tree_idk`, which
is an implementation detail of the platform build.

As such, it cannot be used anymore to cover the `generate_fuchsia_sdk_repository`
use case described in a previous section. To preserve that, it is necessary to
generate a new directory that contains no references to internal platform build
details.

To achieve this:

- The `@fuchsia_in_tree_idk` repository will be processed *at build time*,
  to generate a directory that essentially contains the same content, but
  following the official IDK layout. In other words, this undoes the work
  performed by `fuchsia_idk_repository` by removing all Bazel target labels
  from metadata files.

  Fortunately, doing so it pretty simple.

- Still *at build time*, the `fuchsia_sdk_repository()` function will be
  called to process the previous directory, and generate a final version
  of the in-tree Bazel SDK.

- The symlink generated by `fx build generate_fuchsia_sdk_repository`
  will now point to this directory output, instead of the `@fuchsia_sdk`
  repository:

The Bazel workspace would now look like the following, where `[foo]`
denotes a repository rule call (in Starlark), and `[[bar]]` describes
a function invoked in a build action:

```
|  Bazel Workspace
|
|
--------> @fuchsia_in_tree_idk ------[[final_idk()]]---> @fuchsia_in_tree_idk//:final_idk
|                   |                                                |
|                   |                                                |
|       [fuchsia_sdk_repository()]                      [[fuchsia_sdk_repository()]]
|                   |                                                |
|                   v                                                v
|              @fuchsia_sdk                       //build/bazel/bazel_sdk:final_fuchsia_sdk
|
|
|
|
------> @fuchsia_internal_only_idk
|                   |
|                   |
|       [fuchsia_sdk_repository()]
|                   |
|                   v
|              @internal_sdk
|
|
```

Once this is completed, it will be possible to modify the
way `@fuchsia_in_tree_idk` and `@fuchsia_internal_only_idk` are
generated, e.g. moving the generation of IDK atoms to the Bazel graph
progressively until we can remove them completely from the GN one.

Details on how to do this will be explained later.

Finally, moving the generation of the Core IDK and SDK will be
handled in a separate single step (also to be explained later),
which is possible since nothing, apart from certain builder
configurations, depend on these outputs.
